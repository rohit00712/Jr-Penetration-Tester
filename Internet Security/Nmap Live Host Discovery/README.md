
# Nmap Live Host Discovery

This room explains the steps that Nmap carries out to discover the systems that are online before port-scanning. This stage is crucial because trying to port-scan offline systems will only waste time and create unnecessary noise on the network.

We present the different approaches that Nmap uses to discover live hosts. In particular, we cover:

1. ARP scan: This scan uses ARP requests to discover live hosts

2. ICMP scan: This scan uses ICMP requests to identify live hosts

3. TCP/UDP ping scan: This scan sends packets to TCP ports and UDP ports to determine live hosts.

We also introduce two scanners, `arp-scan` and `masscan`, and explain how they overlap with part of Nmap’s host discovery.

**Nmap :**

we will use Nmap to discover systems and services actively. Nmap was created by `Gordon Lyon (Fyodor)`, a network security expert and open source programmer. It was released in `1997`. Nmap, short for Network Mapper, is free, open-source software released under GPL license. Nmap is an industry-standard tool for mapping networks, identifying live hosts, and discovering running services. Nmap’s scripting engine can further extend its functionality, from fingerprinting services to exploiting vulnerabilities. A Nmap scan usually goes through the steps shown in the figure below, although many are optional and depend on the command-line arguments you provide.

### Nmap_steps.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

# Subnetworks

Let's review a couple of terms before we move on to the main tasks. A network segment is a group of computers connected using a shared medium. For instance, the medium can be the Ethernet switch or WiFi access point. In an IP network, a subnetwork is usually the equivalent of one or more network segments connected together and configured to use the same router. The network segment refers to a physical connection, while a subnetwork refers to a logical connection.

In the following network diagram, we have four network segments or subnetworks. Generally speaking, your system would be connected to one of these network segments/subnetworks. A subnetwork, or simply a subnet, has its own IP address range and is connected to a more extensive network via a router. There might be a firewall enforcing security policies depending on each network.

### subnetting.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

The figure above shows two types of subnets:

* Subnets with `/16`, which means that the subnet mask can be written as `255.255.0.0`. This subnet can have around 65 thousand hosts.
* Subnets with `/24`, which indicates that the subnet mask can be expressed as `255.255.255.0`. This subnet can have around 250 hosts.
You might want to refer to Task 2 in the Intro to LAN room if you need to learn more about subnetting.

As part of active reconnaissance, we want to discover more information about a group of hosts or about a subnet. If you are connected to the same subnet, you would expect your scanner to rely on ARP (Address Resolution Protocol) queries to discover live hosts. An ARP query aims to get the hardware address (MAC address) so that communication over the link-layer becomes possible; however, we can use this to infer that the host is online. (We revisit link-layer in Task 4.)

If you are in Network A, you can use ARP only to discover the devices within that subnet (10.1.100.0/24). Suppose you are connected to a subnet different from the subnet of the target system(s). In that case, all packets generated by your scanner will be routed via the default gateway (router) to reach the systems on another subnet; however, the ARP queries won’t be routed and hence cannot cross the subnet router. ARP is a link-layer protocol, and ARP packets are bound to their subnet.

# Enumerating Target

We mentioned the different techniques we can use for scanning in Task 1. Before we explain each in detail and put it into use against a live target, we need to specify the targets we want to scan. Generally speaking, you can provide a list, a range, or a subnet. Examples of target specification are:

* list: `MACHINE_IP scanme.nmap.org example.com` will scan 3 IP addresses.
* range: `10.11.12.15-20` will scan 6 IP addresses: 10.11.12.15, 10.11.12.16,… and 10.11.12.20.
* subnet: `MACHINE_IP/30` will scan 4 IP addresses.
You can also provide a file as input for your list of targets, `nmap -iL list_of_hosts.txt`.

If you want to check the list of hosts that Nmap will scan, you can use `nmap -sL TARGETS`. This option will give you a detailed list of the hosts that Nmap will scan without scanning them; however, Nmap will attempt a reverse-DNS resolution on all the targets to obtain their names. Names might reveal various information to the pentester. (If you don’t want Nmap to the DNS server, you can add `-n`.)

#  Discovering Live Hosts 

Let’s revisit the TCP/IP layers shown in the figure next. We will leverage the protocols to discover the live hosts. Starting from bottom to top, we can use:

* ARP from Link Layer
* ICMP from Network Layer
* TCP from Transport Layer
* UDP from Transport Layer

### TCP_IPandOSI_model.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

Before we discuss how scanners can use each in detail, we will briefly review these four protocols. ARP has one purpose: sending a frame to the broadcast address on the network segment and asking the computer with a specific IP address to respond by providing its MAC (hardware) address.

ICMP has many types. ICMP ping uses Type 8 (Echo) and Type 0 (Echo Reply).

If you want to ping a system on the same subnet, an ARP query should precede the ICMP Echo.

Although TCP and UDP are transport layers, for network scanning purposes, a scanner can send a specially-crafted packet to common TCP or UDP ports to check whether the target will respond. This method is efficient, especially when ICMP Echo is blocked.

# Nmap Host Discovery Using ARP 

`nmap -PR -sn TARGETS_IP`

`-PR` : for ARP scanning

`-sn` : host discovery only

### arp_scan.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

**ARP-scans**

`arp-scan --localnet` or `arp-scan -l` : scan all the ip address on the local network.

`sudo arp-scan -I eth0 -l` : to provide interface.

`apt install arp-scan` : to install arp-scan

`sudo arp-scan 10.10.210.6/24`

# Nmap Host Discovery Using ICMP 

`nmap -PE -sn TARGET_IP`

`-PE` : ICMP echo requests

`-sn` : host discovery only

### ICMP_echo_request.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

`nmap -PP -sn TARGET_IP`

`-PP` : ICMP Timestamp Request

### ICMP_Timestamp_Request.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

`nmap -PM -sn TARGET_IP`

`-PM` : Address Mask Request

### ICMP_Address_Mass_Request.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

# Nmap Host Discovery Using TCP and UDP 

**TCP SYN Ping Scan**

`sudo nmap -PS -sn 10.10.68.220/24`

`sudo nmap -PS22,80,443 -sn MACHINE_IP/30`

`-PS` : to target default port

`-PS21` : to target port 21 (FTP)

`-PS21-25` : to target port 21, 22, 23, 24, 25

`-PS80,443,8080` : to target port 80, 443, 8080

### tcp_syn.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

**TCP ACK Ping Scan**

`sudo nmap -PA -sn 10.10.68.220/24`

`sudo nmap -PA22,80,443 -sn MACHINE_IP/30`

The following figure shows that any TCP packet with an ACK flag should get a TCP packet back with an RST flag set. The target responds with the RST flag set because the TCP packet with the ACK flag is not part of any ongoing connection. The expected response is used to detect if the target host is up.

### tcp_ack_scan.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

**UDP Ping Scan**

`sudo nmap -PU -sn 10.10.68.220/24`

`sudo nmap -PU53,161,162 -sn MACHINE_IP/30`

In the following figure, we see a UDP packet sent to an open UDP port and not triggering any response. However, sending a UDP packet to any closed UDP port can trigger a response indirectly indicating that the target is online.

### UDP_Ping1.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

### UDP_Ping2.png

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)

**Massscan**

On a side note, Masscan uses a similar approach to discover the available systems. However, to finish its network scan quickly, Masscan is quite aggressive with the rate of packets it generates. The syntax is quite similar: -p can be followed by a port number, list, or range. Consider the following examples:

* masscan MACHINE_IP/24 -p443
* masscan MACHINE_IP/24 -p80,443
* masscan MACHINE_IP/24 -p22-25
* masscan MACHINE_IP/24 ‐‐top-ports 100

Masscan is not installed on the AttackBox; however, it can be installed using `apt install masscan`.

#  Using Reverse-DNS Lookup

Nmap’s default behaviour is to use reverse-DNS online hosts. Because the hostnames can reveal a lot, this can be a helpful step. However, if you don’t want to send such DNS queries, you use `-n` to skip this step.

By default, Nmap will look up online hosts; however, you can use the option `-R` to query the DNS server even for offline hosts. If you want to use a specific DNS server, you can add the `--dns-servers DNS_SERVER` option.

# Summary

You have learned how ARP, ICMP, TCP, and UDP can detect live hosts by completing this room. Any response from a host is an indication that it is online. Below is a quick summary of the command-line options for Nmap that we have covered.


|Scan Type | Example Command                |
| :-------- | :------------------------- |
| ARP Scan | sudo nmap -PR -sn MACHINE_IP/24 |
| ICMP Echo Scan          |      sudo nmap -PE -sn MACHINE_IP/24             |
| ICMP Timestamp Scan | sudo nmap -PP -sn MACHINE_IP/24 |
|ICMP Address Mask Scan |sudo nmap -PM -sn MACHINE_IP/24 |
|TCP SYN Ping Scan |sudo nmap -PS22,80,443 -sn MACHINE_IP/30 |
|TCP ACK Ping Scan | sudo nmap -PA22,80,443 -sn MACHINE_IP/30|
|UDP Ping Scan|sudo nmap -PU53,161,162 -sn MACHINE_IP/30|

Remember to add -sn if you are only interested in host discovery without port-scanning. Omitting -sn will let Nmap default to port-scanning the live hosts.

`-n` : no DNS look up

`-R` : reverse-DNS lookup for all hosts

`-sn` : host discovery only



## Screenshots

![App Screenshot](https://via.placeholder.com/468x300?text=App+Screenshot+Here)


## API Reference

#### Get all items

```http
  GET /api/items
```

| Parameter | Type     | Description                |
| :-------- | :------- | :------------------------- |
| `api_key` | `string` | **Required**. Your API key |

#### Get item

```http
  GET /api/items/${id}
```

| Parameter | Type     | Description                       |
| :-------- | :------- | :-------------------------------- |
| `id`      | `string` | **Required**. Id of item to fetch |

#### add(num1, num2)

Takes two numbers and returns the sum.

